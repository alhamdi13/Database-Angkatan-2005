<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Alumni Tambang UPNVY 2005</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .map-dot { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .map-dot:hover { z-index: 50; transform: translate(-50%, -50%) scale(1.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #eab308;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white sticky top-0 z-40 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-yellow-500 rounded flex items-center justify-center text-slate-900">
                    <i data-lucide="building-2" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">SI-ALUMNI <span class="text-yellow-500">MINING '05</span></h1>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="hidden sm:flex text-xs text-right mr-2 items-center">
                    <span id="status-indicator" class="flex items-center justify-end font-bold mr-3 text-slate-500">
                        <div id="status-dot" class="w-2 h-2 rounded-full mr-1 bg-slate-500"></div> 
                        <span id="status-text">Connecting...</span>
                    </span>
                    <button onclick="fetchData()" class="text-slate-400 hover:text-white transition-colors" title="Refresh Data">
                        <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-1 w-full">
        
        <!-- HERO & SEARCH -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Database Alumni (Live)</h2>
            <p class="text-slate-500 mb-6">Terhubung langsung ke Google Sheet Angkatan 2005.</p>
            
            <div class="flex flex-col sm:flex-row gap-4 max-w-4xl">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-slate-400"></i>
                    </div>
                    <input
                        type="text"
                        id="search-input"
                        class="block w-full pl-10 pr-3 py-4 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 shadow-sm transition-all"
                        placeholder="Cari nama, perusahaan, atau kota..."
                    />
                </div>
                
                <!-- View Switcher -->
                <div class="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm shrink-0">
                    <button id="btn-list-view" class="flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-800 text-white shadow">
                        <i data-lucide="list" class="w-4 h-4 mr-2"></i> Daftar
                    </button>
                    <button id="btn-map-view" class="flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-500 hover:bg-slate-50">
                        <i data-lucide="map" class="w-4 h-4 mr-2"></i> Peta Sebaran
                    </button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD STATS -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="stats-container">
            <!-- Stats will be injected here -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center space-x-4 animate-pulse">
                <div class="w-12 h-12 bg-slate-200 rounded-lg"></div>
                <div class="flex-1 space-y-2"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="h-6 bg-slate-200 rounded w-1/2"></div></div>
            </div>
        </div>

        <!-- CONTENT AREA: LIST VIEW -->
        <div id="list-view-container" class="block">
            <div id="alumni-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards injected via JS -->
            </div>
            <div id="loading-state" class="text-center py-20">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-slate-500">Memuat data dari Google Sheet...</p>
            </div>
            <div id="empty-state" class="hidden text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                <i data-lucide="users" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
                <h3 class="text-lg font-medium text-slate-900">Data Tidak Ditemukan</h3>
                <p class="text-slate-500 mb-4">Coba kata kunci pencarian lain.</p>
            </div>
        </div>

        <!-- CONTENT AREA: MAP VIEW -->
        <div id="map-view-container" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-hidden relative min-h-[500px] flex flex-col">
                
                <!-- Map Header & Controls -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 z-20 relative">
                    <div class="bg-white/90 p-2 rounded-lg shadow-sm border border-slate-100">
                        <p class="font-bold text-slate-800 text-sm">Peta Sebaran Alumni</p>
                        <p class="text-xs text-slate-500" id="map-counter">0 titik lokasi</p>
                    </div>

                    <!-- Filter Dropdown -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                            <i data-lucide="filter" class="h-4 w-4 text-slate-400"></i>
                        </div>
                        <select id="map-filter" class="pl-8 pr-8 py-2 text-sm border border-slate-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-yellow-500 shadow-sm appearance-none cursor-pointer hover:bg-slate-50 transition-colors min-w-[200px]">
                            <option value="all">Semua Lokasi</option>
                            <option disabled>──────────</option>
                            <!-- Options injected via JS -->
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                            <i data-lucide="chevron-right" class="h-4 w-4 text-slate-400 rotate-90"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div class="relative w-full flex-1 bg-blue-50/50 rounded-lg overflow-hidden border border-slate-100 shadow-inner">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bb/Indonesia_adm_location_map.svg" alt="Peta Indonesia" class="absolute inset-0 w-full h-full object-cover opacity-60 mix-blend-multiply" style="object-position: center;">
                    
                    <!-- Map Dots Container -->
                    <div id="map-dots-layer" class="absolute inset-0 w-full h-full"></div>
                </div>
                <div class="mt-2 text-[10px] text-slate-400 text-center italic bg-slate-50 py-1 rounded">
                    *Posisi visual adalah estimasi koordinat dari nama Kota/Provinsi.
                </div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-slate-900 text-slate-400 py-8 mt-12 border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="mb-2">&copy; 2025 Paguyuban Alumni Tambang UPNVY Angkatan 2005.</p>
        </div>
    </footer>

    <!-- MODAL DETAIL -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh] transform transition-all scale-95 opacity-0" id="modal-content">
            <!-- Modal Header -->
            <div class="bg-slate-800 p-6 flex justify-between items-start shrink-0">
                <div class="flex items-center space-x-4">
                    <div id="modal-initials" class="w-16 h-16 rounded-full bg-yellow-500 text-slate-900 flex items-center justify-center font-bold text-2xl shadow-lg border-2 border-white">
                        NN
                    </div>
                    <div>
                        <h2 id="modal-name" class="text-xl font-bold text-white">Nama Alumni</h2>
                        <p id="modal-job" class="text-yellow-400 text-sm font-medium">Pekerjaan</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6 overflow-y-auto">
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center">
                        <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i> Informasi Profesional
                    </h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <p class="text-xs text-slate-500">Perusahaan / Instansi</p>
                            <p id="modal-company" class="font-medium text-slate-800">-</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex-1">
                                <p class="text-xs text-slate-500">Bidang</p>
                                <p id="modal-field" class="font-medium text-slate-800">-</p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex-1">
                                <p class="text-xs text-slate-500">NIM</p>
                                <p id="modal-nim" class="font-medium text-slate-800">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center">
                        <i data-lucide="user" class="w-4 h-4 mr-2"></i> Kontak & Lokasi
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center p-2 hover:bg-slate-50 rounded-lg transition-colors">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Domisili</p>
                                <p id="modal-domicile" class="text-sm font-medium text-slate-800">-</p>
                                <p id="modal-city" class="text-xs text-slate-500">-</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center p-2 hover:bg-slate-50 rounded-lg transition-colors">
                            <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-3">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Nomor HP</p>
                                <p id="modal-phone" class="text-sm font-medium text-slate-800">-</p>
                            </div>
                        </div>

                        <div class="flex items-center p-2 hover:bg-slate-50 rounded-lg transition-colors">
                            <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mr-3">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Email</p>
                                <p id="modal-email" class="text-sm font-medium text-slate-800">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end shrink-0">
                <button onclick="closeModal()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-100 mr-2">
                    Tutup
                </button>
                <a id="modal-wa-link" href="#" target="_blank" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-medium hover:bg-slate-900 flex items-center">
                    Hubungi
                </a>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIG & STATE ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwqI5gOYqGW3rJd1fbMXbWKrnYoxlZ7Clhy5GT-7Z1Co8UuSf97MzE-B25yG8x_VlEn/exec";
        
        let alumniData = [];
        let filteredData = [];
        let viewMode = 'list';
        let mapFilterArea = 'all';

        // --- COORDINATES DATABASE ---
        const CITY_COORDINATES = {
            "balikpapan": { lat: -1.2379, lng: 116.8529 },
            "samarinda": { lat: -0.5022, lng: 117.1536 },
            "sangatta": { lat: 0.5022, lng: 117.5359 },
            "kutai timur": { lat: 0.6, lng: 117.6 },
            "tanjung": { lat: -2.1752, lng: 115.3934 },
            "tabalong": { lat: -2.0, lng: 115.4 },
            "banjarmasin": { lat: -3.3194, lng: 114.5908 },
            "pontianak": { lat: -0.0263, lng: 109.3425 },
            "palangkaraya": { lat: -2.2136, lng: 113.9108 },
            "ketapang": { lat: -1.85, lng: 109.97 },
            "jakarta": { lat: -6.2088, lng: 106.8456 },
            "tangerang": { lat: -6.1702, lng: 106.6403 },
            "bogor": { lat: -6.5971, lng: 106.8060 },
            "bekasi": { lat: -6.2383, lng: 106.9756 },
            "bandung": { lat: -6.9175, lng: 107.6191 },
            "yogyakarta": { lat: -7.7956, lng: 110.3695 },
            "sleman": { lat: -7.7, lng: 110.35 },
            "surabaya": { lat: -7.2575, lng: 112.7521 },
            "gresik": { lat: -7.15, lng: 112.65 },
            "palembang": { lat: -2.9761, lng: 104.7754 },
            "tanjung enim": { lat: -3.75, lng: 103.8 },
            "lahat": { lat: -3.80, lng: 103.54 },
            "pangkalpinang": { lat: -2.13, lng: 106.11 },
            "bangka": { lat: -1.9, lng: 106.0 },
            "medan": { lat: 3.5952, lng: 98.6722 },
            "pekanbaru": { lat: 0.5071, lng: 101.4478 },
            "padang": { lat: -0.9471, lng: 100.4172 },
            "makassar": { lat: -5.1477, lng: 119.4328 },
            "manado": { lat: 1.4748, lng: 124.8421 },
            "kendari": { lat: -3.9973, lng: 122.5151 },
            "morowali": { lat: -2.6, lng: 121.9 },
            "palu": { lat: -0.9010, lng: 119.8707 },
            "sumbawa": { lat: -8.5, lng: 117.4 },
            "mataram": { lat: -8.5833, lng: 116.1167 },
            "timika": { lat: -4.5446, lng: 136.8874 },
            "jayapura": { lat: -2.5, lng: 140.7 },
            "sorong": { lat: -0.87, lng: 131.25 }
        };

        // --- HELPER FUNCTIONS ---
        const formatWhatsApp = (phone) => {
            if (!phone) return "#";
            let cleanPhone = phone.toString().replace(/[^0-9]/g, '');
            if (cleanPhone.startsWith('0')) cleanPhone = '62' + cleanPhone.slice(1);
            return `https://wa.me/${cleanPhone}`;
        };

        const getInitials = (name) => {
            if (!name) return "NN";
            return name.toString().split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        };

        const getCoordinates = (city, province) => {
            const cleanCity = city?.toString().toLowerCase().trim() || "";
            const cleanProv = province?.toString().toLowerCase().trim() || "";
            
            for (const [key, value] of Object.entries(CITY_COORDINATES)) {
                if (cleanCity.includes(key)) return value;
            }
            
            // Fallback Provincies
            if (cleanProv.includes('kalimantan timur')) return { lat: 0.5, lng: 116.5 };
            if (cleanProv.includes('kalimantan selatan')) return { lat: -2.5, lng: 115.5 };
            if (cleanProv.includes('jawa barat')) return { lat: -6.9, lng: 107.6 };
            if (cleanProv.includes('jawa timur')) return { lat: -7.5, lng: 112.5 };
            if (cleanProv.includes('sumatera selatan')) return { lat: -3.3, lng: 104.0 };
            if (cleanProv.includes('papua')) return { lat: -4.0, lng: 138.0 };
            return null;
        };

        // --- CORE LOGIC ---
        
        async function fetchData() {
            // Update UI status
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('animate-spin');
            document.getElementById('status-text').innerText = "Connecting...";
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full mr-1 bg-yellow-500 animate-pulse";
            
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('alumni-grid').innerHTML = '';
            document.getElementById('empty-state').classList.add('hidden');

            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (result.status === 'success') {
                    alumniData = result.data;
                    filteredData = alumniData;
                    
                    renderStats();
                    renderList();
                    renderMap();
                    
                    // Success UI
                    document.getElementById('status-text').innerText = "Online";
                    document.getElementById('status-text').className = "text-green-500";
                    document.getElementById('status-dot').className = "w-2 h-2 rounded-full mr-1 bg-green-500 animate-pulse";
                    document.getElementById('loading-state').classList.add('hidden');
                }
            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('status-text').innerText = "Offline";
                document.getElementById('status-text').className = "text-red-500";
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full mr-1 bg-red-500";
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        function filterData(searchTerm) {
            const lowerTerm = searchTerm.toLowerCase();
            filteredData = alumniData.filter(item => 
                (item.nama && item.nama.toString().toLowerCase().includes(lowerTerm)) ||
                (item.perusahaan && item.perusahaan.toString().toLowerCase().includes(lowerTerm)) ||
                (item.provinsi && item.provinsi.toString().toLowerCase().includes(lowerTerm)) ||
                (item.kota && item.kota.toString().toLowerCase().includes(lowerTerm))
            );
            
            renderList();
            renderMap();
        }

        // --- RENDER FUNCTIONS ---

        function renderStats() {
            const total = alumniData.length;
            const uniqueCompanies = new Set(alumniData.map(d => d.perusahaan).filter(p => p && p !== '-' && p !== '')).size;
            const uniqueProvinces = new Set(alumniData.map(d => d.provinsi).filter(p => p)).size;
            const jobTypes = alumniData.reduce((acc, curr) => {
                const type = (curr.pekerjaan === "Karyawan Swasta" || curr.pekerjaan === "Pegawai BUMN/BUMD") ? "Professional" : "Lainnya";
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const statsHtml = `
                ${createStatCard('Total Alumni', total, 'users', 'bg-blue-600')}
                ${createStatCard('Perusahaan', uniqueCompanies, 'briefcase', 'bg-yellow-600')}
                ${createStatCard('Sebaran Provinsi', uniqueProvinces, 'globe', 'bg-emerald-600')}
                ${createStatCard('Profesional', jobTypes['Professional'] || 0, 'bar-chart-3', 'bg-purple-600')}
            `;
            
            document.getElementById('stats-container').innerHTML = statsHtml;
            lucide.createIcons();
        }

        function createStatCard(title, value, icon, colorClass) {
            const textColor = colorClass.replace('bg-', 'text-');
            return `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center space-x-4 transition-transform hover:-translate-y-1 duration-300">
                <div class="p-3 rounded-lg ${colorClass} bg-opacity-10">
                    <i data-lucide="${icon}" class="w-6 h-6 ${textColor}"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">${title}</p>
                    <h3 class="text-2xl font-bold text-slate-800">${value}</h3>
                </div>
            </div>`;
        }

        function renderList() {
            const grid = document.getElementById('alumni-grid');
            grid.innerHTML = '';

            if (filteredData.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            filteredData.forEach((alumni, index) => {
                const initials = getInitials(alumni.nama);
                const badgeClass = (alumni.pekerjaan === "Karyawan Swasta" || alumni.pekerjaan === "Pegawai BUMN/BUMD") 
                    ? "bg-blue-50 text-blue-700 border-blue-100" 
                    : "bg-slate-100 text-slate-600 border-slate-200";
                
                // Escape strings to prevent XSS and JSON parsing errors in onclick
                const safeAlumni = encodeURIComponent(JSON.stringify(alumni));

                const cardHtml = `
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden flex flex-col h-full group">
                    <div class="p-5 flex-1">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full bg-slate-800 text-yellow-500 flex items-center justify-center font-bold text-lg shadow-inner shrink-0">
                                    ${initials}
                                </div>
                                <div class="min-w-0">
                                    <h3 class="font-bold text-slate-800 group-hover:text-blue-700 transition-colors truncate">${alumni.nama}</h3>
                                    <p class="text-xs text-slate-500 font-mono truncate">NIM: ${alumni.nim || "-"}</p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full font-medium border whitespace-nowrap ${badgeClass}">
                                ${alumni.pekerjaan || "Lainnya"}
                            </span>
                        </div>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-start text-sm text-slate-600">
                                <i data-lucide="building-2" class="w-4 h-4 mr-2 mt-0.5 text-slate-400 shrink-0"></i>
                                <span class="line-clamp-2">${alumni.perusahaan || "Freelance / Lainnya"}</span>
                            </div>
                            <div class="flex items-start text-sm text-slate-600">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-2 mt-0.5 text-slate-400 shrink-0"></i>
                                <span class="line-clamp-1">${alumni.kota || "-"}, ${alumni.provinsi || "-"}</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-3 border-t border-slate-100 flex justify-between items-center gap-2">
                        <a href="${formatWhatsApp(alumni.hp)}" target="_blank" class="flex-1 flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <span>WhatsApp</span>
                        </a>
                        <button onclick="openModal('${safeAlumni}')" class="px-3 py-2 bg-white border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>`;
                grid.insertAdjacentHTML('beforeend', cardHtml);
            });
            lucide.createIcons();
        }

        function renderMap() {
            const mapContainer = document.getElementById('map-dots-layer');
            mapContainer.innerHTML = '';
            
            // 1. Group Locations
            const locations = {};
            filteredData.forEach(person => {
                const coords = getCoordinates(person.kota, person.provinsi);
                if (coords) {
                    const key = `${coords.lat},${coords.lng}`;
                    if (!locations[key]) {
                        locations[key] = { ...coords, count: 0, people: [], city: person.kota || person.provinsi };
                    }
                    locations[key].count += 1;
                    locations[key].people.push(person);
                }
            });
            const groupedLocations = Object.values(locations);

            // 2. Update Filter Dropdown
            const filterSelect = document.getElementById('map-filter');
            // Keep first 2 options (All and separator)
            while (filterSelect.options.length > 2) { filterSelect.remove(2); }
            
            const uniqueAreas = [...new Set(groupedLocations.map(l => l.city))].sort();
            uniqueAreas.forEach(area => {
                const opt = document.createElement('option');
                opt.value = area;
                opt.text = area;
                filterSelect.add(opt);
            });
            filterSelect.value = mapFilterArea; // Restore selection

            // 3. Render Dots
            const visibleLocations = groupedLocations.filter(loc => 
                mapFilterArea === 'all' || loc.city === mapFilterArea
            );
            
            document.getElementById('map-counter').innerText = `${visibleLocations.length} titik lokasi ${mapFilterArea !== 'all' ? 'terpilih' : 'total'}`;

            const MIN_LONG = 95.0; const MAX_LONG = 141.0;
            const MIN_LAT = -11.0; const MAX_LAT = 6.0;

            visibleLocations.forEach(loc => {
                const x = ((loc.lng - MIN_LONG) / (MAX_LONG - MIN_LONG)) * 100;
                const y = ((MAX_LAT - loc.lat) / (MAX_LAT - MIN_LAT)) * 100;
                
                const size = Math.min(50, 24 + (loc.count * 4));
                const isSelected = mapFilterArea === loc.city;
                
                const dot = document.createElement('div');
                dot.className = `map-dot absolute group flex items-center justify-center cursor-pointer ${isSelected ? 'z-30' : 'z-10'}`;
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                dot.style.transform = 'translate(-50%, -50%)';

                // People list for tooltip
                const peopleList = loc.people.map(p => `
                    <li class="flex items-start">
                        <div class="w-1.5 h-1.5 rounded-full bg-blue-400 mt-1 mr-2 shrink-0"></div>
                        <span class="truncate">${p.nama}</span>
                    </li>
                `).join('');

                dot.innerHTML = `
                    <div class="rounded-full flex items-center justify-center text-xs font-bold shadow-md border-2 border-white transition-all
                        ${isSelected ? 'bg-blue-600 text-white animate-bounce' : 'bg-yellow-500/80 text-slate-900'}
                    " style="width: ${size}px; height: ${size}px;">
                        ${loc.count}
                    </div>
                    
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-56 bg-slate-900/95 backdrop-blur text-white text-xs p-3 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-40 transform scale-95 group-hover:scale-100 origin-bottom">
                        <div class="font-bold border-b border-slate-700 pb-2 mb-2 text-yellow-400 uppercase tracking-wider flex justify-between items-center">
                            <span>${loc.city || "Lokasi"}</span>
                            <span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px] text-white">${loc.count} org</span>
                        </div>
                        <ul class="space-y-1.5 max-h-40 overflow-y-auto custom-scrollbar">
                            ${peopleList}
                        </ul>
                    </div>
                `;
                mapContainer.appendChild(dot);
            });
        }

        // --- MODAL FUNCTIONS ---

        function openModal(safeAlumniString) {
            const data = JSON.parse(decodeURIComponent(safeAlumniString));
            
            // Populate Modal
            document.getElementById('modal-initials').innerText = getInitials(data.nama);
            document.getElementById('modal-name').innerText = data.nama;
            document.getElementById('modal-job').innerText = data.pekerjaan || "-";
            document.getElementById('modal-company').innerText = data.perusahaan || "-";
            document.getElementById('modal-field').innerText = data.bidang || "-";
            document.getElementById('modal-nim').innerText = data.nim || "-";
            document.getElementById('modal-domicile').innerText = data.domisili || "-";
            document.getElementById('modal-city').innerText = `${data.kota || "-"}, ${data.provinsi || "-"}`;
            document.getElementById('modal-phone').innerText = data.hp || "-";
            document.getElementById('modal-email').innerText = data.email || "-";
            document.getElementById('modal-wa-link').href = formatWhatsApp(data.hp);

            // Show Modal with Animation
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            // Small timeout to allow removing hidden to apply opacity transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95', 'opacity-0');
            content.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- EVENT LISTENERS ---

        document.getElementById('search-input').addEventListener('input', (e) => {
            filterData(e.target.value);
        });

        document.getElementById('btn-list-view').addEventListener('click', () => {
            document.getElementById('list-view-container').classList.remove('hidden');
            document.getElementById('map-view-container').classList.add('hidden');
            
            // Update button styles
            document.getElementById('btn-list-view').className = "flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-800 text-white shadow";
            document.getElementById('btn-map-view').className = "flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-500 hover:bg-slate-50";
        });

        document.getElementById('btn-map-view').addEventListener('click', () => {
            document.getElementById('list-view-container').classList.add('hidden');
            document.getElementById('map-view-container').classList.remove('hidden');

             // Update button styles
            document.getElementById('btn-map-view').className = "flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-800 text-white shadow";
            document.getElementById('btn-list-view').className = "flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-500 hover:bg-slate-50";
            
            // Force redraw map to handle container size
            renderMap();
        });

        document.getElementById('map-filter').addEventListener('change', (e) => {
            mapFilterArea = e.target.value;
            renderMap();
        });

        // Close modal on outside click
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') closeModal();
        });

        // INIT
        lucide.createIcons();
        fetchData();

    </script>
</body>
</html>
